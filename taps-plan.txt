# Beertracker Taps Module Implementation Plan
# Updated: January 17, 2026
# This plan outlines the implementation of taps.pm for updating the tap_beers table based on scraper data.

Try to follow code style in prompt.txt 

## Overview
The taps.pm module will handle updating the tap_beers table when scraping beer lists from locations.
- For each scraped tap with a beer: Update or create tap_beers records, closing old ones if the beer changes.
- Close any active taps not present in the scrape (including empty taps).
- Update LastSeen for all remaining active taps.
- Add a marker record (Tap=NULL) to indicate the last scrape time for the location.

## Dependencies
- Relies on scrapeboard.pm for scraped data (beerlist with brew_id added).
- Uses db.pm for DB access, util.pm for now().
- Leverages the current_taps view for querying active taps.

## Module Structure
- File: code/taps.pm
- Package: taps
- Exports: update_taps

## Function: update_taps($c, $location_id, $beerlist)
### Parameters
- $c: Context hash with DB handle ($c->{dbh})
- $location_id: ID of the location being scraped
- $beerlist: Array ref of scraped taps (each with id, maker, beer, brew_id, etc.)

### Logic Steps
1. Get current timestamp: $now = util::now()
2. Initialize %scraped_taps hash to track tap numbers in scrape
3. Loop through each $tap in @$beerlist:
   - Skip if !$tap->{brew_id}
   - $tap_num = $tap->{id}
   - $scraped_taps{$tap_num} = 1
   - Query current active record: SELECT * FROM current_taps WHERE Location = ? AND Tap = ?
   - If current exists:
     - If current->{Brew} == $tap->{brew_id}: Log "Tap $tap_num beer unchanged"
     - Else: UPDATE tap_beers SET Gone = ? WHERE Id = ? (log "Closed tap $tap_num"), then INSERT new record (log "Opened tap $tap_num with brew $tap->{brew_id}")
   - Else: INSERT new record (log "Opened tap $tap_num with brew $tap->{brew_id}")
4. Close missing taps:
   - Query: SELECT Tap, Id FROM current_taps WHERE Location = ?
   - For each result where !$scraped_taps{$row->{Tap}}: UPDATE tap_beers SET Gone = ? WHERE Id = ? (log "Closed tap $row->{Tap} (not scraped)")
5. Update LastSeen for active taps:
   - UPDATE tap_beers SET LastSeen = ? WHERE Location = ? AND Gone IS NULL (log "Updated LastSeen for active taps")
6. Add scrape marker:
   - INSERT INTO tap_beers (Location, Tap, Brew, FirstSeen, LastSeen) VALUES (?, NULL, NULL, ?, ?) (log "Added scrape marker for location $location_id")

### SQL Details
- Use prepared statements for all queries.
- INSERT: INSERT INTO tap_beers (Location, Tap, Brew, FirstSeen, LastSeen) VALUES (?, ?, ?, ?, ?)
- UPDATE Gone: UPDATE tap_beers SET Gone = ? WHERE Id = ?
- UPDATE LastSeen: UPDATE tap_beers SET LastSeen = ? WHERE Location = ? AND Gone IS NULL

### Logging
- Use print STDERR for all actions (e.g., "taps: Closed tap 5 at location 123")
- Later: Restrict to status changes only.

### Integration
- In scrapeboard.pm updateboard():
  - After getting $loc_id = db::findrecord($c, "LOCATIONS", "Name", $locparam)->{Id}
  - After adding brew_id to $beerlist
  - Call taps::update_taps($c, $loc_id, $beerlist)

### Testing
- Run scraper for a location, check tap_beers table for correct inserts/updates/closes.
- Verify marker record with Tap=NULL.
- Test with empty taps, beer changes, unchanged taps.

### Future Enhancements
- Use CURRENT_TIMESTAMP instead of util::now()
- Optimize LastSeen updates (e.g., only if >1 hour old)
- Rescrape logic: Check marker's LastSeen to decide if rescrape needed.</content>
<parameter name="filePath">/home/heikki/proj/beertracker-dev/taps-plan.txt